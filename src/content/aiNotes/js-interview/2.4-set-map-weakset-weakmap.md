
---
title: 2.1 - Set/Mapã€WeakSet/WeakMap
aiNotebook: js-interview
date: 2026-02-04
tags: ['JavaScript', 'é¢è¯•']
excerpt: Set/Mapã€WeakSet/WeakMap
order: 10
---

# JavaScript é›†åˆæ•°æ®ç»“æ„æ·±åº¦è§£æ

> æ·±å…¥ç†è§£ Set/Mapã€WeakSet/WeakMap çš„åŸç†ã€åº”ç”¨ä¸é¢è¯•è¦ç‚¹

## ç›®å½•

- [ä¸€ã€Set æ·±åº¦è§£æ](#ä¸€set-æ·±åº¦è§£æ)
- [äºŒã€Map æ·±åº¦è§£æ](#äºŒmap-æ·±åº¦è§£æ)
- [ä¸‰ã€WeakSet æ·±åº¦è§£æ](#ä¸‰weakset-æ·±åº¦è§£æ)
- [å››ã€WeakMap æ·±åº¦è§£æ](#å››weakmap-æ·±åº¦è§£æ)
- [äº”ã€åº•å±‚å®ç°åŸç†](#äº”åº•å±‚å®ç°åŸç†)
- [å…­ã€å®æˆ˜åº”ç”¨åœºæ™¯](#å…­å®æˆ˜åº”ç”¨åœºæ™¯)
- [ä¸ƒã€é¢è¯•é«˜é¢‘é—®é¢˜](#ä¸ƒé¢è¯•é«˜é¢‘é—®é¢˜)
- [å…«ã€æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–](#å…«æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–)

---

## ä¸€ã€Set æ·±åº¦è§£æ

### 1.1 Set çš„æœ¬è´¨

Set æ˜¯ ES6 å¼•å…¥çš„**é›†åˆæ•°æ®ç»“æ„**,ç±»ä¼¼äºæ•°ç»„,ä½†**æˆå‘˜å€¼éƒ½æ˜¯å”¯ä¸€çš„**,æ²¡æœ‰é‡å¤å€¼ã€‚

```javascript
const set = new Set([1, 2, 3, 3, 4]);
console.log(set); // Set(4) { 1, 2, 3, 4 }
console.log(set.size); // 4
```

### 1.2 Set çš„æ ¸å¿ƒç‰¹æ€§

#### 1.2.1 å€¼çš„å”¯ä¸€æ€§

Set ä½¿ç”¨ **"Same-value-zero equality"** ç®—æ³•åˆ¤æ–­å€¼æ˜¯å¦ç›¸åŒ:

```javascript
const set = new Set();

// åŸºæœ¬ç±»å‹å»é‡
set.add(1);
set.add('1');
set.add(true);
set.add(1); // é‡å¤,ä¸ä¼šæ·»åŠ 
console.log(set); // Set(3) { 1, '1', true }

// NaN çš„ç‰¹æ®Šå¤„ç†
set.add(NaN);
set.add(NaN); // NaN è¢«è®¤ä¸ºæ˜¯ç›¸ç­‰çš„
console.log(set.has(NaN)); // true

// å¯¹è±¡å¼•ç”¨
const obj1 = { a: 1 };
const obj2 = { a: 1 };
set.add(obj1);
set.add(obj2); // ä¸åŒå¼•ç”¨,éƒ½ä¼šæ·»åŠ 
console.log(set.size); // åŒ…å«ä¸¤ä¸ªå¯¹è±¡

// undefined å’Œ null
set.add(undefined);
set.add(null);
set.add(undefined); // é‡å¤
console.log(set.has(undefined)); // true
```

**é‡è¦é¢è¯•ç‚¹**:
- `NaN === NaN` è¿”å› false,ä½† Set è®¤ä¸º NaN ç›¸ç­‰
- `+0` å’Œ `-0` åœ¨ Set ä¸­è¢«è®¤ä¸ºæ˜¯ç›¸ç­‰çš„
- å¯¹è±¡æ¯”è¾ƒçš„æ˜¯å¼•ç”¨åœ°å€,ä¸æ˜¯å€¼

#### 1.2.2 æœ‰åºæ€§

Set ä¿æŒæ’å…¥é¡ºåº:

```javascript
const set = new Set([3, 1, 4, 1, 5]);
console.log([...set]); // [3, 1, 4, 5] ä¿æŒæ’å…¥é¡ºåº
```

### 1.3 Set çš„ API

```javascript
const set = new Set();

// æ·»åŠ å…ƒç´ 
set.add(1).add(2).add(3); // æ”¯æŒé“¾å¼è°ƒç”¨

// åˆ é™¤å…ƒç´ 
set.delete(2); // è¿”å› boolean
console.log(set.has(2)); // false

// æ£€æŸ¥å…ƒç´ 
console.log(set.has(1)); // true

// æ¸…ç©º
set.clear();
console.log(set.size); // 0

// éå†æ–¹æ³•
const fruits = new Set(['apple', 'banana', 'orange']);

// forEach
fruits.forEach((value, key, set) => {
  console.log(value); // æ³¨æ„: value === key
});

// for...of
for (let fruit of fruits) {
  console.log(fruit);
}

// è¿­ä»£å™¨æ–¹æ³•
console.log([...fruits.keys()]); // ['apple', 'banana', 'orange']
console.log([...fruits.values()]); // ['apple', 'banana', 'orange']
console.log([...fruits.entries()]); // [['apple', 'apple'], ...]
```

**é¢è¯•é‡ç‚¹**: Set çš„ `forEach` å›è°ƒå‡½æ•°ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå‚æ•°éƒ½æ˜¯å€¼,è¿™æ˜¯ä¸ºäº†ä¸ Map ä¿æŒ API ä¸€è‡´æ€§ã€‚

### 1.4 Set çš„å®é™…åº”ç”¨

#### 1.4.1 æ•°ç»„å»é‡

```javascript
// åŸºæœ¬ç±»å‹å»é‡
const arr = [1, 2, 2, 3, 4, 4, 5];
const uniqueArr = [...new Set(arr)];
console.log(uniqueArr); // [1, 2, 3, 4, 5]

// å­—ç¬¦ä¸²å»é‡
const str = 'aabbccdd';
const uniqueStr = [...new Set(str)].join('');
console.log(uniqueStr); // 'abcd'

// å¤æ‚å¯¹è±¡å»é‡(éœ€è¦è‡ªå®šä¹‰é€»è¾‘)
const users = [
  { id: 1, name: 'Alice' },
  { id: 2, name: 'Bob' },
  { id: 1, name: 'Alice' }
];

// æ–¹æ¡ˆ1: ä½¿ç”¨ Map
const uniqueUsers = [...new Map(users.map(u => [u.id, u])).values()];

// æ–¹æ¡ˆ2: ä½¿ç”¨ filter + findIndex
const uniqueUsers2 = users.filter((user, index, arr) => 
  arr.findIndex(u => u.id === user.id) === index
);
```

#### 1.4.2 é›†åˆè¿ç®—

```javascript
// å¹¶é›†
function union(setA, setB) {
  return new Set([...setA, ...setB]);
}

// äº¤é›†
function intersection(setA, setB) {
  return new Set([...setA].filter(x => setB.has(x)));
}

// å·®é›†
function difference(setA, setB) {
  return new Set([...setA].filter(x => !setB.has(x)));
}

// å¯¹ç§°å·®é›†(å¹¶é›† - äº¤é›†)
function symmetricDifference(setA, setB) {
  const diff1 = difference(setA, setB);
  const diff2 = difference(setB, setA);
  return union(diff1, diff2);
}

// ç¤ºä¾‹
const setA = new Set([1, 2, 3, 4]);
const setB = new Set([3, 4, 5, 6]);

console.log([...union(setA, setB)]); // [1, 2, 3, 4, 5, 6]
console.log([...intersection(setA, setB)]); // [3, 4]
console.log([...difference(setA, setB)]); // [1, 2]
console.log([...symmetricDifference(setA, setB)]); // [1, 2, 5, 6]
```

#### 1.4.3 åˆ¤æ–­è¶…é›†å’Œå­é›†

```javascript
function isSuperset(set, subset) {
  for (let elem of subset) {
    if (!set.has(elem)) {
      return false;
    }
  }
  return true;
}

function isSubset(subset, set) {
  return isSuperset(set, subset);
}

const setA = new Set([1, 2, 3, 4, 5]);
const setB = new Set([2, 3]);

console.log(isSuperset(setA, setB)); // true
console.log(isSubset(setB, setA)); // true
```

---

## äºŒã€Map æ·±åº¦è§£æ

### 2.1 Map çš„æœ¬è´¨

Map æ˜¯é”®å€¼å¯¹çš„é›†åˆ,ç±»ä¼¼äºå¯¹è±¡,ä½†**é”®å¯ä»¥æ˜¯ä»»æ„ç±»å‹**,ä¸ä»…é™äºå­—ç¬¦ä¸²ã€‚

```javascript
const map = new Map();
map.set('name', 'Alice');
map.set(42, 'answer');
map.set(true, 'boolean key');
map.set({ id: 1 }, 'object key');

console.log(map.size); // 4
```

### 2.2 Map vs Object

| ç‰¹æ€§ | Map | Object |
|------|-----|--------|
| é”®çš„ç±»å‹ | ä»»æ„ç±»å‹ | String/Symbol |
| é”®çš„é¡ºåº | æ’å…¥é¡ºåº | æ— åº(éƒ¨åˆ†æœ‰åº) |
| å¤§å°è·å– | `map.size` | `Object.keys(obj).length` |
| è¿­ä»£ | åŸç”Ÿå¯è¿­ä»£ | éœ€è¦ `Object.keys()` |
| æ€§èƒ½ | é¢‘ç¹å¢åˆ æ›´ä¼˜ | å°æ•°æ®é‡æ›´ä¼˜ |
| åŸå‹é“¾ | æ— åŸå‹é“¾æ±¡æŸ“ | æœ‰åŸå‹é“¾ |

```javascript
// Object çš„é™åˆ¶
const obj = {};
obj[{ id: 1 }] = 'value1';
obj[{ id: 2 }] = 'value2';
console.log(obj); // { '[object Object]': 'value2' } é”®è¢«è½¬ä¸ºå­—ç¬¦ä¸²

// Map å¯ä»¥ä½¿ç”¨å¯¹è±¡ä½œä¸ºé”®
const map = new Map();
const key1 = { id: 1 };
const key2 = { id: 2 };
map.set(key1, 'value1');
map.set(key2, 'value2');
console.log(map.get(key1)); // 'value1'
console.log(map.get(key2)); // 'value2'
```

### 2.3 Map çš„ API

```javascript
const map = new Map();

// è®¾ç½®é”®å€¼å¯¹
map.set('a', 1);
map.set('b', 2);
map.set('c', 3);

// è·å–å€¼
console.log(map.get('a')); // 1
console.log(map.get('d')); // undefined

// æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
console.log(map.has('a')); // true

// åˆ é™¤é”®å€¼å¯¹
map.delete('b');
console.log(map.has('b')); // false

// æ¸…ç©º
map.clear();
console.log(map.size); // 0

// é€šè¿‡æ•°ç»„åˆå§‹åŒ–
const map2 = new Map([
  ['name', 'Alice'],
  ['age', 25],
  ['city', 'Beijing']
]);

// éå†æ–¹æ³•
map2.forEach((value, key, map) => {
  console.log(`${key}: ${value}`);
});

// è¿­ä»£å™¨
console.log([...map2.keys()]); // ['name', 'age', 'city']
console.log([...map2.values()]); // ['Alice', 25, 'Beijing']
console.log([...map2.entries()]); // [['name', 'Alice'], ...]

// for...of
for (let [key, value] of map2) {
  console.log(`${key}: ${value}`);
}
```

### 2.4 Map çš„å®é™…åº”ç”¨

#### 2.4.1 ç¼“å­˜/è®°å¿†åŒ–

```javascript
// æ–æ³¢é‚£å¥‘æ•°åˆ—ç¼“å­˜
function fibonacci() {
  const cache = new Map();
  
  return function fib(n) {
    if (n <= 1) return n;
    
    if (cache.has(n)) {
      return cache.get(n);
    }
    
    const result = fib(n - 1) + fib(n - 2);
    cache.set(n, result);
    return result;
  };
}

const fib = fibonacci();
console.log(fib(10)); // 55
console.log(fib(50)); // 12586269025 å¿«é€Ÿè®¡ç®—
```

#### 2.4.2 å¯¹è±¡å±æ€§ç»Ÿè®¡

```javascript
function countProperties(obj) {
  const counts = new Map();
  
  for (let key in obj) {
    if (obj.hasOwnProperty(key)) {
      const type = typeof obj[key];
      counts.set(type, (counts.get(type) || 0) + 1);
    }
  }
  
  return counts;
}

const obj = { a: 1, b: '2', c: true, d: null, e: undefined };
const counts = countProperties(obj);
console.log([...counts]); // [['number', 1], ['string', 1], ...]
```

#### 2.4.3 DOM èŠ‚ç‚¹å…ƒæ•°æ®å­˜å‚¨

```javascript
// ä½¿ç”¨ Map å­˜å‚¨ DOM èŠ‚ç‚¹çš„é¢å¤–æ•°æ®
class DOMDataStore {
  constructor() {
    this.store = new Map();
  }
  
  set(element, key, value) {
    if (!this.store.has(element)) {
      this.store.set(element, new Map());
    }
    this.store.get(element).set(key, value);
  }
  
  get(element, key) {
    const elementData = this.store.get(element);
    return elementData ? elementData.get(key) : undefined;
  }
  
  delete(element) {
    return this.store.delete(element);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const dataStore = new DOMDataStore();
const button = document.querySelector('button');
dataStore.set(button, 'clickCount', 0);
dataStore.set(button, 'lastClicked', Date.now());
```

#### 2.4.4 LRU ç¼“å­˜å®ç°

```javascript
class LRUCache {
  constructor(capacity) {
    this.capacity = capacity;
    this.cache = new Map();
  }
  
  get(key) {
    if (!this.cache.has(key)) return -1;
    
    // æ›´æ–°è®¿é—®é¡ºåº:åˆ é™¤åé‡æ–°æ·»åŠ 
    const value = this.cache.get(key);
    this.cache.delete(key);
    this.cache.set(key, value);
    return value;
  }
  
  put(key, value) {
    // å¦‚æœå­˜åœ¨,å…ˆåˆ é™¤æ—§çš„
    if (this.cache.has(key)) {
      this.cache.delete(key);
    }
    
    // æ·»åŠ æ–°çš„
    this.cache.set(key, value);
    
    // è¶…å‡ºå®¹é‡,åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„(ç¬¬ä¸€ä¸ª)
    if (this.cache.size > this.capacity) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const lru = new LRUCache(3);
lru.put(1, 'a');
lru.put(2, 'b');
lru.put(3, 'c');
console.log(lru.get(1)); // 'a'
lru.put(4, 'd'); // ç§»é™¤ 2
console.log(lru.get(2)); // -1
```

---

## ä¸‰ã€WeakSet æ·±åº¦è§£æ

### 3.1 WeakSet çš„æœ¬è´¨

WeakSet æ˜¯ Set çš„å˜ä½“,ä½†æœ‰é‡è¦åŒºåˆ«:
- **åªèƒ½å­˜å‚¨å¯¹è±¡**,ä¸èƒ½å­˜å‚¨åŸºæœ¬ç±»å‹å€¼
- **å¯¹è±¡å¼•ç”¨æ˜¯å¼±å¼•ç”¨**,ä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶
- **ä¸å¯è¿­ä»£**,æ²¡æœ‰ size å±æ€§

```javascript
const ws = new WeakSet();

const obj1 = { id: 1 };
const obj2 = { id: 2 };

ws.add(obj1);
ws.add(obj2);

console.log(ws.has(obj1)); // true

// ä¸èƒ½æ·»åŠ åŸºæœ¬ç±»å‹
// ws.add(1); // TypeError: Invalid value used in weak set
```

### 3.2 å¼±å¼•ç”¨çš„åŸç†

```javascript
// å¼ºå¼•ç”¨ç¤ºä¾‹(Set)
let obj = { data: 'important' };
const set = new Set();
set.add(obj);

obj = null; // obj å¼•ç”¨è§£é™¤
// ä½†å¯¹è±¡ä»ç„¶åœ¨ set ä¸­,ä¸ä¼šè¢«åƒåœ¾å›æ”¶
console.log(set.size); // 1

// å¼±å¼•ç”¨ç¤ºä¾‹(WeakSet)
let obj2 = { data: 'important' };
const ws = new WeakSet();
ws.add(obj2);

obj2 = null; // obj2 å¼•ç”¨è§£é™¤
// å¯¹è±¡å¯èƒ½è¢«åƒåœ¾å›æ”¶(å–å†³äº GC æ—¶æœº)
// æ— æ³•éªŒè¯ ws.size,å› ä¸º WeakSet æ²¡æœ‰ size å±æ€§
```

**å…³é”®ç†è§£**:
- å¼ºå¼•ç”¨: `Set`ã€`Map`ã€æ•°ç»„ã€å¯¹è±¡å±æ€§éƒ½ä¼šåˆ›å»ºå¼ºå¼•ç”¨
- å¼±å¼•ç”¨: `WeakSet`ã€`WeakMap` ä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶
- GC æ—¶æœºä¸ç¡®å®š,å¼€å‘è€…æ— æ³•ç²¾ç¡®æ§åˆ¶

### 3.3 WeakSet çš„ API

WeakSet åªæœ‰ä¸‰ä¸ªæ–¹æ³•:

```javascript
const ws = new WeakSet();
const obj = { id: 1 };

ws.add(obj);        // æ·»åŠ å¯¹è±¡
ws.has(obj);        // æ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨
ws.delete(obj);     // åˆ é™¤å¯¹è±¡

// æ²¡æœ‰ä»¥ä¸‹æ–¹æ³•:
// ws.size          // âŒ
// ws.clear()       // âŒ
// ws.keys()        // âŒ
// ws.values()      // âŒ
// ws.forEach()     // âŒ
```

### 3.4 WeakSet çš„å®é™…åº”ç”¨

#### 3.4.1 æ ‡è®°å¯¹è±¡(ä¸å½±å“ç”Ÿå‘½å‘¨æœŸ)

```javascript
// æ ‡è®° DOM èŠ‚ç‚¹æ˜¯å¦å·²ç¦ç”¨
const disabledElements = new WeakSet();

function disableElement(element) {
  element.disabled = true;
  disabledElements.add(element);
}

function isDisabled(element) {
  return disabledElements.has(element);
}

// å½“ DOM èŠ‚ç‚¹è¢«ç§»é™¤æ—¶,WeakSet ä¸­çš„å¼•ç”¨ä¼šè‡ªåŠ¨æ¸…ç†
const button = document.querySelector('button');
disableElement(button);
console.log(isDisabled(button)); // true

// button ä» DOM ç§»é™¤å,ä¼šè¢«åƒåœ¾å›æ”¶
button.remove();
```

#### 3.4.2 é˜²æ­¢å¯¹è±¡è¢«å¤šæ¬¡å¤„ç†

```javascript
// é˜²æ­¢å¾ªç¯å¼•ç”¨å¯¼è‡´çš„æ— é™é€’å½’
function traverseObject(obj, visited = new WeakSet()) {
  // é¿å…é‡å¤è®¿é—®
  if (visited.has(obj)) {
    console.log('å·²è®¿é—®è¿‡,è·³è¿‡');
    return;
  }
  
  visited.add(obj);
  
  for (let key in obj) {
    if (typeof obj[key] === 'object' && obj[key] !== null) {
      traverseObject(obj[key], visited);
    }
  }
}

// å¾ªç¯å¼•ç”¨çš„å¯¹è±¡
const a = { name: 'a' };
const b = { name: 'b' };
a.ref = b;
b.ref = a;

traverseObject(a); // ä¸ä¼šæ— é™é€’å½’
```

#### 3.4.3 ç§æœ‰æ•°æ®å­˜å‚¨

```javascript
// ä½¿ç”¨ WeakSet å®ç°ç®€å•çš„ç§æœ‰æ ‡è®°
const privateData = new WeakSet();

class User {
  constructor(name) {
    this.name = name;
    privateData.add(this); // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
  }
  
  isInitialized() {
    return privateData.has(this);
  }
}

const user = new User('Alice');
console.log(user.isInitialized()); // true
```

---

## å››ã€WeakMap æ·±åº¦è§£æ

### 4.1 WeakMap çš„æœ¬è´¨

WeakMap æ˜¯ Map çš„å˜ä½“:
- **é”®å¿…é¡»æ˜¯å¯¹è±¡**,å€¼å¯ä»¥æ˜¯ä»»æ„ç±»å‹
- **é”®æ˜¯å¼±å¼•ç”¨**,ä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶
- **ä¸å¯è¿­ä»£**,æ²¡æœ‰ size å±æ€§

```javascript
const wm = new WeakMap();

const key1 = { id: 1 };
const key2 = { id: 2 };

wm.set(key1, 'value1');
wm.set(key2, 'value2');

console.log(wm.get(key1)); // 'value1'

// é”®å¿…é¡»æ˜¯å¯¹è±¡
// wm.set('string', 'value'); // TypeError
```

### 4.2 WeakMap çš„ API

```javascript
const wm = new WeakMap();
const obj = { id: 1 };

wm.set(obj, { data: 'value' });  // è®¾ç½®
wm.get(obj);                     // è·å–
wm.has(obj);                     // æ£€æŸ¥
wm.delete(obj);                  // åˆ é™¤

// æ²¡æœ‰ä»¥ä¸‹æ–¹æ³•:
// wm.size          // âŒ
// wm.clear()       // âŒ
// wm.keys()        // âŒ
// wm.values()      // âŒ
// wm.forEach()     // âŒ
```

### 4.3 WeakMap çš„å®é™…åº”ç”¨

#### 4.3.1 DOM èŠ‚ç‚¹å…ƒæ•°æ®å­˜å‚¨(é˜²æ­¢å†…å­˜æ³„æ¼)

```javascript
// ä½¿ç”¨ WeakMap å­˜å‚¨ DOM èŠ‚ç‚¹æ•°æ®
const elementData = new WeakMap();

function setElementData(element, data) {
  elementData.set(element, data);
}

function getElementData(element) {
  return elementData.get(element);
}

// ä½¿ç”¨ç¤ºä¾‹
const button = document.querySelector('button');
setElementData(button, {
  clickCount: 0,
  lastClicked: null
});

button.addEventListener('click', () => {
  const data = getElementData(button);
  data.clickCount++;
  data.lastClicked = Date.now();
});

// å½“ button ä» DOM ç§»é™¤æ—¶,WeakMap ä¸­çš„æ•°æ®ä¼šè‡ªåŠ¨æ¸…ç†
// ä¸ä¼šé€ æˆå†…å­˜æ³„æ¼
```

#### 4.3.2 å¯¹è±¡ç§æœ‰æ•°æ®å®ç°

```javascript
// ä½¿ç”¨ WeakMap å®ç°çœŸæ­£çš„ç§æœ‰å±æ€§
const privateData = new WeakMap();

class Person {
  constructor(name, age) {
    privateData.set(this, { name, age });
  }
  
  getName() {
    return privateData.get(this).name;
  }
  
  getAge() {
    return privateData.get(this).age;
  }
  
  setAge(age) {
    const data = privateData.get(this);
    data.age = age;
  }
}

const person = new Person('Alice', 25);
console.log(person.getName()); // 'Alice'
console.log(person.name); // undefined - çœŸæ­£çš„ç§æœ‰
console.log(privateData.get(person)); // undefined - å¤–éƒ¨æ— æ³•è®¿é—®
```

#### 4.3.3 ç¼“å­˜è®¡ç®—ç»“æœ

```javascript
// ä½¿ç”¨ WeakMap ç¼“å­˜å¯¹è±¡çš„è®¡ç®—ç»“æœ
const cache = new WeakMap();

function expensiveOperation(obj) {
  if (cache.has(obj)) {
    console.log('ä»ç¼“å­˜è¿”å›');
    return cache.get(obj);
  }
  
  console.log('æ‰§è¡Œè®¡ç®—');
  const result = obj.value * 2; // å‡è®¾è¿™æ˜¯æ˜‚è´µçš„è®¡ç®—
  cache.set(obj, result);
  return result;
}

const obj1 = { value: 10 };
console.log(expensiveOperation(obj1)); // æ‰§è¡Œè®¡ç®— -> 20
console.log(expensiveOperation(obj1)); // ä»ç¼“å­˜è¿”å› -> 20

// å½“ obj1 ä¸å†è¢«å¼•ç”¨æ—¶,ç¼“å­˜ä¼šè‡ªåŠ¨æ¸…ç†
```

#### 4.3.4 å®ç°è§‚å¯Ÿè€…æ¨¡å¼

```javascript
// ä½¿ç”¨ WeakMap å®ç°è§‚å¯Ÿè€…æ¨¡å¼
const observers = new WeakMap();

function observe(target, callback) {
  if (!observers.has(target)) {
    observers.set(target, []);
  }
  observers.get(target).push(callback);
}

function notify(target, data) {
  const callbacks = observers.get(target);
  if (callbacks) {
    callbacks.forEach(callback => callback(data));
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const user = { name: 'Alice' };

observe(user, data => console.log('Observer 1:', data));
observe(user, data => console.log('Observer 2:', data));

notify(user, { action: 'update', name: 'Bob' });
// Observer 1: { action: 'update', name: 'Bob' }
// Observer 2: { action: 'update', name: 'Bob' }
```

#### 4.3.5 è®°å½•å¯¹è±¡æ–¹æ³•è°ƒç”¨æ¬¡æ•°

```javascript
const callCounts = new WeakMap();

function trackMethodCalls(obj, methodName) {
  const originalMethod = obj[methodName];
  
  if (!callCounts.has(obj)) {
    callCounts.set(obj, {});
  }
  
  const counts = callCounts.get(obj);
  counts[methodName] = 0;
  
  obj[methodName] = function(...args) {
    counts[methodName]++;
    return originalMethod.apply(this, args);
  };
}

function getCallCount(obj, methodName) {
  const counts = callCounts.get(obj);
  return counts ? counts[methodName] : 0;
}

// ä½¿ç”¨ç¤ºä¾‹
const calculator = {
  add(a, b) { return a + b; }
};

trackMethodCalls(calculator, 'add');

calculator.add(1, 2);
calculator.add(3, 4);
calculator.add(5, 6);

console.log(getCallCount(calculator, 'add')); // 3
```

---

## äº”ã€åº•å±‚å®ç°åŸç†

### 5.1 å“ˆå¸Œè¡¨(Hash Table)åŸç†

Set å’Œ Map åº•å±‚éƒ½åŸºäº**å“ˆå¸Œè¡¨**å®ç°:

```
åŸç†æµç¨‹:
1. è®¡ç®—é”®çš„å“ˆå¸Œå€¼(hash code)
2. å°†å“ˆå¸Œå€¼æ˜ å°„åˆ°æ•°ç»„ç´¢å¼•(é€šå¸¸æ˜¯ hash % array.length)
3. åœ¨è¯¥ç´¢å¼•ä½ç½®å­˜å‚¨å€¼(å¤„ç†å“ˆå¸Œå†²çª)
```

```javascript
// ç®€åŒ–çš„å“ˆå¸Œè¡¨å®ç°
class SimpleHashMap {
  constructor(size = 16) {
    this.buckets = new Array(size);
    this.size = 0;
  }
  
  // ç®€å•çš„å“ˆå¸Œå‡½æ•°
  hash(key) {
    let hash = 0;
    const str = String(key);
    for (let i = 0; i < str.length; i++) {
      hash = (hash << 5) - hash + str.charCodeAt(i);
      hash = hash & hash; // è½¬ä¸º32ä½æ•´æ•°
    }
    return Math.abs(hash) % this.buckets.length;
  }
  
  set(key, value) {
    const index = this.hash(key);
    
    if (!this.buckets[index]) {
      this.buckets[index] = [];
    }
    
    // æ£€æŸ¥é”®æ˜¯å¦å·²å­˜åœ¨
    const bucket = this.buckets[index];
    for (let i = 0; i < bucket.length; i++) {
      if (bucket[i][0] === key) {
        bucket[i][1] = value;
        return;
      }
    }
    
    // æ·»åŠ æ–°é”®å€¼å¯¹
    bucket.push([key, value]);
    this.size++;
  }
  
  get(key) {
    const index = this.hash(key);
    const bucket = this.buckets[index];
    
    if (!bucket) return undefined;
    
    for (let [k, v] of bucket) {
      if (k === key) return v;
    }
    
    return undefined;
  }
}
```

### 5.2 å“ˆå¸Œå†²çªå¤„ç†

V8 å¼•æ“ä½¿ç”¨**å¼€æ”¾å¯»å€æ³•**(Open Addressing)å¤„ç†å†²çª:

```javascript
// å¼€æ”¾å¯»å€æ³•ç¤ºä¾‹
class OpenAddressingHashMap {
  constructor(size = 16) {
    this.keys = new Array(size);
    this.values = new Array(size);
    this.size = 0;
    this.capacity = size;
  }
  
  hash(key, attempt = 0) {
    let hash = 0;
    const str = String(key);
    for (let i = 0; i < str.length; i++) {
      hash = (hash << 5) - hash + str.charCodeAt(i);
    }
    // çº¿æ€§æ¢æµ‹
    return (Math.abs(hash) + attempt) % this.capacity;
  }
  
  set(key, value) {
    let attempt = 0;
    
    while (attempt < this.capacity) {
      const index = this.hash(key, attempt);
      
      if (this.keys[index] === undefined || this.keys[index] === key) {
        this.keys[index] = key;
        this.values[index] = value;
        this.size++;
        return;
      }
      
      attempt++;
    }
    
    throw new Error('HashTable is full');
  }
  
  get(key) {
    let attempt = 0;
    
    while (attempt < this.capacity) {
      const index = this.hash(key, attempt);
      
      if (this.keys[index] === key) {
        return this.values[index];
      }
      
      if (this.keys[index] === undefined) {
        return undefined;
      }
      
      attempt++;
    }
    
    return undefined;
  }
}
```

### 5.3 åŠ¨æ€æ‰©å®¹

å½“å“ˆå¸Œè¡¨çš„**è´Ÿè½½å› å­**(size / capacity)è¶…è¿‡é˜ˆå€¼æ—¶,ä¼šè§¦å‘æ‰©å®¹:

```javascript
class DynamicHashMap {
  constructor(initialCapacity = 16) {
    this.capacity = initialCapacity;
    this.size = 0;
    this.loadFactor = 0.75;
    this.buckets = new Array(this.capacity);
  }
  
  shouldResize() {
    return this.size / this.capacity >= this.loadFactor;
  }
  
  resize() {
    const oldBuckets = this.buckets;
    this.capacity *= 2;
    this.buckets = new Array(this.capacity);
    this.size = 0;
    
    // é‡æ–°å“ˆå¸Œæ‰€æœ‰å…ƒç´ 
    for (let bucket of oldBuckets) {
      if (bucket) {
        for (let [key, value] of bucket) {
          this.set(key, value);
        }
      }
    }
  }
  
  set(key, value) {
    if (this.shouldResize()) {
      this.resize();
    }
    
    // ... æ­£å¸¸çš„ set é€»è¾‘
  }
}
```

**V8 å®ç°ç»†èŠ‚**:
- åˆå§‹å®¹é‡: 16
- è´Ÿè½½å› å­: 0.75
- æ‰©å®¹ç­–ç•¥: å®¹é‡ç¿»å€
- æ—¶é—´å¤æ‚åº¦: å¹³å‡ O(1),æœ€å O(n)(éœ€è¦æ‰©å®¹æ—¶)

### 5.4 WeakMap/WeakSet çš„å®ç°

WeakMap å’Œ WeakSet ä½¿ç”¨**å¼±å¼•ç”¨**å®ç°:

```
æ ¸å¿ƒæœºåˆ¶:
1. é”®ä½¿ç”¨ ephemeron table(çŸ­æš‚è¡¨)å­˜å‚¨
2. å¦‚æœé”®å¯¹è±¡æ²¡æœ‰å…¶ä»–å¼ºå¼•ç”¨,GC å¯ä»¥å›æ”¶
3. é”®è¢«å›æ”¶å,å¯¹åº”çš„é”®å€¼å¯¹è‡ªåŠ¨ä»è¡¨ä¸­ç§»é™¤
```

```javascript
// æ¦‚å¿µç¤ºæ„(å®é™…ç”± C++ å®ç°)
class WeakMapConcept {
  constructor() {
    // å†…éƒ¨ä½¿ç”¨ C++ çš„ ephemeron table
    this._table = createEphemeronTable();
  }
  
  set(key, value) {
    if (typeof key !== 'object') {
      throw new TypeError('Invalid key type');
    }
    // å­˜å‚¨å¼±å¼•ç”¨
    this._table.setWeak(key, value);
  }
  
  get(key) {
    // å¦‚æœé”®å·²è¢« GC,è¿”å› undefined
    return this._table.getWeak(key);
  }
}
```

**å…³é”®ç†è§£**:
- WeakMap/WeakSet ä¸ä¼šå¢åŠ é”®å¯¹è±¡çš„å¼•ç”¨è®¡æ•°
- åƒåœ¾å›æ”¶å™¨å¯ä»¥å¿½ç•¥è¿™äº›å¼±å¼•ç”¨
- æ— æ³•æšä¸¾,å› ä¸ºé”®çš„å­˜åœ¨çŠ¶æ€ä¸ç¡®å®š

---

## å…­ã€å®æˆ˜åº”ç”¨åœºæ™¯

### 6.1 Set åº”ç”¨åœºæ™¯

#### åœºæ™¯1: æƒé™ç®¡ç†

```javascript
class PermissionManager {
  constructor() {
    this.permissions = new Map();
  }
  
  addPermissions(userId, ...perms) {
    if (!this.permissions.has(userId)) {
      this.permissions.set(userId, new Set());
    }
    perms.forEach(perm => this.permissions.get(userId).add(perm));
  }
  
  hasPermission(userId, perm) {
    const userPerms = this.permissions.get(userId);
    return userPerms ? userPerms.has(perm) : false;
  }
  
  removePermission(userId, perm) {
    const userPerms = this.permissions.get(userId);
    if (userPerms) {
      userPerms.delete(perm);
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const pm = new PermissionManager();
pm.addPermissions('user1', 'read', 'write', 'delete');
console.log(pm.hasPermission('user1', 'write')); // true
pm.removePermission('user1', 'delete');
console.log(pm.hasPermission('user1', 'delete')); // false
```

#### åœºæ™¯2: äº‹ä»¶å»é‡

```javascript
class UniqueEventEmitter {
  constructor() {
    this.events = new Map();
  }
  
  on(event, callback) {
    if (!this.events.has(event)) {
      this.events.set(event, new Set());
    }
    this.events.get(event).add(callback);
  }
  
  off(event, callback) {
    const callbacks = this.events.get(event);
    if (callbacks) {
      callbacks.delete(callback);
    }
  }
  
  emit(event, ...args) {
    const callbacks = this.events.get(event);
    if (callbacks) {
      callbacks.forEach(callback => callback(...args));
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const emitter = new UniqueEventEmitter();
const handler = (data) => console.log(data);

emitter.on('message', handler);
emitter.on('message', handler); // é‡å¤æ·»åŠ ,ä½†åªä¼šæ‰§è¡Œä¸€æ¬¡
emitter.emit('message', 'Hello'); // åªè¾“å‡ºä¸€æ¬¡
```

### 6.2 Map åº”ç”¨åœºæ™¯

#### åœºæ™¯1: è·¯ç”±ç®¡ç†

```javascript
class Router {
  constructor() {
    this.routes = new Map();
  }
  
  register(path, handler) {
    this.routes.set(path, handler);
  }
  
  navigate(path) {
    const handler = this.routes.get(path);
    if (handler) {
      handler();
    } else {
      console.log('404 Not Found');
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const router = new Router();
router.register('/home', () => console.log('Home Page'));
router.register('/about', () => console.log('About Page'));
router.navigate('/home'); // Home Page
```

#### åœºæ™¯2: è¯·æ±‚å»é‡(é˜²æ­¢é‡å¤æäº¤)

```javascript
class RequestDeduplicator {
  constructor() {
    this.pendingRequests = new Map();
  }
  
  async request(url, options = {}) {
    const key = this.generateKey(url, options);
    
    // å¦‚æœè¯·æ±‚æ­£åœ¨è¿›è¡Œä¸­,è¿”å›ç›¸åŒçš„ Promise
    if (this.pendingRequests.has(key)) {
      console.log('è¿”å›ç¼“å­˜çš„è¯·æ±‚');
      return this.pendingRequests.get(key);
    }
    
    // åˆ›å»ºæ–°è¯·æ±‚
    const promise = fetch(url, options)
      .then(response => response.json())
      .finally(() => {
        // è¯·æ±‚å®Œæˆåæ¸…é™¤
        this.pendingRequests.delete(key);
      });
    
    this.pendingRequests.set(key, promise);
    return promise;
  }
  
  generateKey(url, options) {
    return `${options.method || 'GET'}-${url}-${JSON.stringify(options.body)}`;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const dedup = new RequestDeduplicator();

// åŒæ—¶å‘èµ·å¤šä¸ªç›¸åŒè¯·æ±‚
Promise.all([
  dedup.request('/api/user/1'),
  dedup.request('/api/user/1'),
  dedup.request('/api/user/1')
]).then(results => {
  console.log('åªå‘é€äº†ä¸€æ¬¡è¯·æ±‚');
  console.log(results); // ä¸‰ä¸ªç»“æœç›¸åŒ
});
```

### 6.3 WeakMap åº”ç”¨åœºæ™¯

#### åœºæ™¯1: Vue3 å“åº”å¼ç³»ç»Ÿ(ç®€åŒ–ç‰ˆ)

```javascript
const targetMap = new WeakMap();

function track(target, key) {
  let depsMap = targetMap.get(target);
  if (!depsMap) {
    targetMap.set(target, (depsMap = new Map()));
  }
  
  let dep = depsMap.get(key);
  if (!dep) {
    depsMap.set(key, (dep = new Set()));
  }
  
  // æ”¶é›†ä¾èµ–
  if (activeEffect) {
    dep.add(activeEffect);
  }
}

function trigger(target, key) {
  const depsMap = targetMap.get(target);
  if (!depsMap) return;
  
  const dep = depsMap.get(key);
  if (dep) {
    dep.forEach(effect => effect());
  }
}

function reactive(target) {
  return new Proxy(target, {
    get(target, key) {
      track(target, key);
      return target[key];
    },
    set(target, key, value) {
      target[key] = value;
      trigger(target, key);
      return true;
    }
  });
}

// ä½¿ç”¨ç¤ºä¾‹
let activeEffect = null;

function watchEffect(effect) {
  activeEffect = effect;
  effect();
  activeEffect = null;
}

const state = reactive({ count: 0 });

watchEffect(() => {
  console.log('Count:', state.count);
});

state.count++; // è‡ªåŠ¨è§¦å‘: Count: 1
```

#### åœºæ™¯2: React Hooks çŠ¶æ€ç®¡ç†(ç®€åŒ–ç‰ˆ)

```javascript
const componentStates = new WeakMap();

class Component {
  constructor() {
    componentStates.set(this, {
      hooks: [],
      currentHook: 0
    });
  }
  
  useState(initialValue) {
    const state = componentStates.get(this);
    const currentHook = state.currentHook;
    
    if (state.hooks[currentHook] === undefined) {
      state.hooks[currentHook] = initialValue;
    }
    
    const setValue = (newValue) => {
      state.hooks[currentHook] = newValue;
      this.render();
    };
    
    state.currentHook++;
    return [state.hooks[currentHook], setValue];
  }
  
  render() {
    const state = componentStates.get(this);
    state.currentHook = 0; // é‡ç½® hook ç´¢å¼•
    // è§¦å‘é‡æ–°æ¸²æŸ“...
  }
}
```

### 6.4 WeakSet åº”ç”¨åœºæ™¯

#### åœºæ™¯1: é˜²æ­¢ XSS æ”»å‡»(æ ‡è®°å¯ä¿¡ HTML)

```javascript
const trustedHTML = new WeakSet();

function createTrustedHTML(htmlString) {
  const div = document.createElement('div');
  div.innerHTML = htmlString;
  trustedHTML.add(div);
  return div;
}

function insertHTML(element, html) {
  if (trustedHTML.has(html)) {
    element.appendChild(html);
  } else {
    throw new Error('Untrusted HTML detected!');
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const safe = createTrustedHTML('<p>Safe content</p>');
const unsafe = document.createElement('div');
unsafe.innerHTML = '<script>alert("XSS")</script>';

insertHTML(document.body, safe); // âœ“ å…è®¸
// insertHTML(document.body, unsafe); // âœ— æŠ›å‡ºé”™è¯¯
```

#### åœºæ™¯2: æ ‡è®°å·²è®¿é—®çš„å¯¹è±¡(é¿å…å¾ªç¯ä¾èµ–)

```javascript
function deepClone(obj, visited = new WeakSet()) {
  if (obj === null || typeof obj !== 'object') {
    return obj;
  }
  
  if (visited.has(obj)) {
    throw new Error('Circular reference detected');
  }
  
  visited.add(obj);
  
  const clone = Array.isArray(obj) ? [] : {};
  
  for (let key in obj) {
    if (obj.hasOwnProperty(key)) {
      clone[key] = deepClone(obj[key], visited);
    }
  }
  
  return clone;
}

// æµ‹è¯•å¾ªç¯å¼•ç”¨
const a = { name: 'a' };
const b = { name: 'b' };
a.ref = b;
b.ref = a;

try {
  deepClone(a);
} catch (e) {
  console.log(e.message); // Circular reference detected
}
```

---

## ä¸ƒã€é¢è¯•é«˜é¢‘é—®é¢˜

### 7.1 åŸºç¡€é—®é¢˜

#### Q1: Set å’Œ Array çš„åŒºåˆ«?

**ç­”æ¡ˆè¦ç‚¹**:
1. **å”¯ä¸€æ€§**: Set æˆå‘˜å”¯ä¸€,Array å¯é‡å¤
2. **æŸ¥æ‰¾æ€§èƒ½**: Set æŸ¥æ‰¾ O(1),Array æŸ¥æ‰¾ O(n)
3. **é¡ºåº**: Set ä¿æŒæ’å…¥é¡ºåº,Array ä¹Ÿä¿æŒé¡ºåº
4. **æ–¹æ³•**: Set æœ‰ `add/delete/has`,Array æœ‰ `push/pop/splice`

```javascript
// æ€§èƒ½å¯¹æ¯”
const arr = Array.from({ length: 10000 }, (_, i) => i);
const set = new Set(arr);

console.time('Array.includes');
arr.includes(9999);
console.timeEnd('Array.includes'); // ~0.1ms

console.time('Set.has');
set.has(9999);
console.timeEnd('Set.has'); // ~0.001ms
```

#### Q2: Map å’Œ Object çš„åŒºåˆ«?

**ç­”æ¡ˆè¦ç‚¹**:

| ç‰¹æ€§ | Map | Object |
|------|-----|--------|
| é”®ç±»å‹ | ä»»æ„ç±»å‹ | String/Symbol |
| é”®é¡ºåº | æ’å…¥é¡ºåº | éƒ¨åˆ†æœ‰åº |
| å¤§å° | `map.size` | éœ€æ‰‹åŠ¨è®¡ç®— |
| è¿­ä»£ | åŸç”Ÿå¯è¿­ä»£ | éœ€ `Object.keys()` |
| æ€§èƒ½ | é¢‘ç¹å¢åˆ æ›´ä¼˜ | å°æ•°æ®é‡æ›´ä¼˜ |
| ç»§æ‰¿ | æ— åŸå‹é“¾ | æœ‰åŸå‹é“¾ |
| JSON | ä¸æ”¯æŒ | æ”¯æŒ |

```javascript
// é”®ç±»å‹å¯¹æ¯”
const obj = {};
const key1 = { id: 1 };
const key2 = { id: 2 };

obj[key1] = 'value1';
obj[key2] = 'value2';
console.log(obj); // { '[object Object]': 'value2' }

const map = new Map();
map.set(key1, 'value1');
map.set(key2, 'value2');
console.log(map.size); // 2
```

#### Q3: WeakMap å’Œ Map çš„åŒºåˆ«?

**ç­”æ¡ˆè¦ç‚¹**:

| ç‰¹æ€§ | WeakMap | Map |
|------|---------|-----|
| é”®ç±»å‹ | åªèƒ½æ˜¯å¯¹è±¡ | ä»»æ„ç±»å‹ |
| å¼•ç”¨æ–¹å¼ | å¼±å¼•ç”¨ | å¼ºå¼•ç”¨ |
| å¯è¿­ä»£æ€§ | ä¸å¯è¿­ä»£ | å¯è¿­ä»£ |
| size å±æ€§ | æ—  | æœ‰ |
| åƒåœ¾å›æ”¶ | è‡ªåŠ¨æ¸…ç† | éœ€æ‰‹åŠ¨æ¸…ç† |
| ä½¿ç”¨åœºæ™¯ | ç§æœ‰æ•°æ®ã€ç¼“å­˜ | é€šç”¨é”®å€¼å¯¹ |

```javascript
// å†…å­˜ç®¡ç†å¯¹æ¯”
let obj = { data: 'important' };

// Map - å¼ºå¼•ç”¨
const map = new Map();
map.set(obj, 'value');
obj = null; // å¯¹è±¡ä»åœ¨ map ä¸­,ä¸ä¼šè¢«å›æ”¶

// WeakMap - å¼±å¼•ç”¨
const wm = new WeakMap();
let obj2 = { data: 'important' };
wm.set(obj2, 'value');
obj2 = null; // å¯¹è±¡å¯èƒ½è¢«å›æ”¶
```

### 7.2 è¿›é˜¶é—®é¢˜

#### Q4: å¦‚ä½•å®ç°ä¸€ä¸ªæ”¯æŒè¿‡æœŸæ—¶é—´çš„ Map?

```javascript
class ExpirableMap {
  constructor() {
    this.map = new Map();
  }
  
  set(key, value, ttl = null) {
    const entry = { value, expireAt: ttl ? Date.now() + ttl : null };
    this.map.set(key, entry);
  }
  
  get(key) {
    const entry = this.map.get(key);
    if (!entry) return undefined;
    
    if (entry.expireAt && Date.now() > entry.expireAt) {
      this.map.delete(key);
      return undefined;
    }
    
    return entry.value;
  }
  
  has(key) {
    return this.get(key) !== undefined;
  }
  
  // æ¸…ç†è¿‡æœŸé¡¹
  cleanup() {
    const now = Date.now();
    for (let [key, entry] of this.map) {
      if (entry.expireAt && now > entry.expireAt) {
        this.map.delete(key);
      }
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const cache = new ExpirableMap();
cache.set('token', 'abc123', 5000); // 5ç§’åè¿‡æœŸ

console.log(cache.get('token')); // 'abc123'
setTimeout(() => {
  console.log(cache.get('token')); // undefined
}, 6000);
```

#### Q5: å¦‚ä½•ç”¨ WeakMap å®ç°å¯¹è±¡çš„ç§æœ‰å±æ€§?

```javascript
// æ–¹æ¡ˆ1: å•ä¸ª WeakMap
const privateProps = new WeakMap();

class BankAccount {
  constructor(balance) {
    privateProps.set(this, { balance });
  }
  
  getBalance() {
    return privateProps.get(this).balance;
  }
  
  deposit(amount) {
    const props = privateProps.get(this);
    props.balance += amount;
  }
  
  withdraw(amount) {
    const props = privateProps.get(this);
    if (props.balance >= amount) {
      props.balance -= amount;
      return true;
    }
    return false;
  }
}

const account = new BankAccount(1000);
console.log(account.getBalance()); // 1000
console.log(account.balance); // undefined - æ— æ³•è®¿é—®

// æ–¹æ¡ˆ2: å¤šä¸ª WeakMap(æ›´ç»†ç²’åº¦)
const _balance = new WeakMap();
const _owner = new WeakMap();

class SecureBankAccount {
  constructor(owner, balance) {
    _owner.set(this, owner);
    _balance.set(this, balance);
  }
  
  getOwner() {
    return _owner.get(this);
  }
  
  getBalance() {
    return _balance.get(this);
  }
}
```

#### Q6: Set å¦‚ä½•å®ç°äº¤é›†ã€å¹¶é›†ã€å·®é›†?

```javascript
class SetOperations {
  // å¹¶é›†
  static union(setA, setB) {
    return new Set([...setA, ...setB]);
  }
  
  // äº¤é›†
  static intersection(setA, setB) {
    return new Set([...setA].filter(x => setB.has(x)));
  }
  
  // å·®é›† A - B
  static difference(setA, setB) {
    return new Set([...setA].filter(x => !setB.has(x)));
  }
  
  // å¯¹ç§°å·®é›†
  static symmetricDifference(setA, setB) {
    const diff1 = this.difference(setA, setB);
    const diff2 = this.difference(setB, setA);
    return this.union(diff1, diff2);
  }
  
  // åˆ¤æ–­å­é›†
  static isSubset(subset, superset) {
    return [...subset].every(x => superset.has(x));
  }
  
  // åˆ¤æ–­è¶…é›†
  static isSuperset(superset, subset) {
    return this.isSubset(subset, superset);
  }
}

// æµ‹è¯•
const setA = new Set([1, 2, 3, 4]);
const setB = new Set([3, 4, 5, 6]);

console.log([...SetOperations.union(setA, setB)]); // [1,2,3,4,5,6]
console.log([...SetOperations.intersection(setA, setB)]); // [3,4]
console.log([...SetOperations.difference(setA, setB)]); // [1,2]
console.log(SetOperations.isSubset(new Set([1, 2]), setA)); // true
```

### 7.3 åœºæ™¯é—®é¢˜

#### Q7: å¦‚ä½•å®ç°ä¸€ä¸ª LRU ç¼“å­˜?

```javascript
class LRUCache {
  constructor(capacity) {
    this.capacity = capacity;
    this.cache = new Map();
  }
  
  get(key) {
    if (!this.cache.has(key)) return -1;
    
    // æ›´æ–°è®¿é—®é¡ºåº
    const value = this.cache.get(key);
    this.cache.delete(key);
    this.cache.set(key, value);
    return value;
  }
  
  put(key, value) {
    // å¦‚æœå·²å­˜åœ¨,åˆ é™¤æ—§çš„
    if (this.cache.has(key)) {
      this.cache.delete(key);
    }
    
    // æ·»åŠ æ–°çš„
    this.cache.set(key, value);
    
    // è¶…å‡ºå®¹é‡,åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„
    if (this.cache.size > this.capacity) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
  }
  
  // è¾…åŠ©æ–¹æ³•
  toString() {
    return JSON.stringify([...this.cache]);
  }
}

// æµ‹è¯•
const lru = new LRUCache(3);
lru.put(1, 'a'); // [(1,'a')]
lru.put(2, 'b'); // [(1,'a'), (2,'b')]
lru.put(3, 'c'); // [(1,'a'), (2,'b'), (3,'c')]
lru.get(1);      // [(2,'b'), (3,'c'), (1,'a')]
lru.put(4, 'd'); // [(3,'c'), (1,'a'), (4,'d')] - ç§»é™¤ 2
console.log(lru.get(2)); // -1
```

#### Q8: å¦‚ä½•é˜²æ­¢å¾ªç¯å¼•ç”¨å¯¼è‡´çš„å†…å­˜æ³„æ¼?

```javascript
// åœºæ™¯: æ·±åº¦å…‹éš†æ—¶é¿å…å¾ªç¯å¼•ç”¨
function deepCloneWithWeakMap(obj, hash = new WeakMap()) {
  // å¤„ç†åŸå§‹ç±»å‹å’Œ null
  if (obj === null || typeof obj !== 'object') {
    return obj;
  }
  
  // å¤„ç† Date
  if (obj instanceof Date) {
    return new Date(obj);
  }
  
  // å¤„ç†æ­£åˆ™
  if (obj instanceof RegExp) {
    return new RegExp(obj);
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²å…‹éš†è¿‡(é˜²æ­¢å¾ªç¯å¼•ç”¨)
  if (hash.has(obj)) {
    return hash.get(obj);
  }
  
  // åˆ›å»ºå…‹éš†å¯¹è±¡
  const clone = Array.isArray(obj) ? [] : {};
  hash.set(obj, clone);
  
  // é€’å½’å…‹éš†å±æ€§
  for (let key in obj) {
    if (obj.hasOwnProperty(key)) {
      clone[key] = deepCloneWithWeakMap(obj[key], hash);
    }
  }
  
  return clone;
}

// æµ‹è¯•å¾ªç¯å¼•ç”¨
const obj1 = { name: 'obj1' };
const obj2 = { name: 'obj2' };
obj1.ref = obj2;
obj2.ref = obj1;

const cloned = deepCloneWithWeakMap(obj1);
console.log(cloned.name); // 'obj1'
console.log(cloned.ref.name); // 'obj2'
console.log(cloned.ref.ref === cloned); // true
```

#### Q9: WeakMap åœ¨ DOM äº‹ä»¶ç›‘å¬ä¸­çš„åº”ç”¨?

```javascript
// åœºæ™¯: é¿å… DOM èŠ‚ç‚¹å†…å­˜æ³„æ¼
class EventManager {
  constructor() {
    this.listeners = new WeakMap();
  }
  
  addEventListener(element, event, handler) {
    if (!this.listeners.has(element)) {
      this.listeners.set(element, new Map());
    }
    
    const elementListeners = this.listeners.get(element);
    if (!elementListeners.has(event)) {
      elementListeners.set(event, new Set());
    }
    
    elementListeners.get(event).add(handler);
    element.addEventListener(event, handler);
  }
  
  removeEventListener(element, event, handler) {
    const elementListeners = this.listeners.get(element);
    if (!elementListeners) return;
    
    const eventHandlers = elementListeners.get(event);
    if (!eventHandlers) return;
    
    eventHandlers.delete(handler);
    element.removeEventListener(event, handler);
  }
  
  removeAllListeners(element) {
    const elementListeners = this.listeners.get(element);
    if (!elementListeners) return;
    
    for (let [event, handlers] of elementListeners) {
      for (let handler of handlers) {
        element.removeEventListener(event, handler);
      }
    }
    
    this.listeners.delete(element);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const eventManager = new EventManager();
const button = document.createElement('button');

const clickHandler = () => console.log('Clicked!');
eventManager.addEventListener(button, 'click', clickHandler);

// å½“ button ä» DOM ç§»é™¤å,WeakMap ä¼šè‡ªåŠ¨æ¸…ç†
button.remove(); // ä¸ä¼šé€ æˆå†…å­˜æ³„æ¼
```

---

## å…«ã€æ€§èƒ½å¯¹æ¯”ä¸ä¼˜åŒ–

### 8.1 æ—¶é—´å¤æ‚åº¦å¯¹æ¯”

| æ“ä½œ | Array | Set | Map | Object |
|------|-------|-----|-----|--------|
| æŸ¥æ‰¾ | O(n) | O(1) | O(1) | O(1) |
| æ’å…¥ | O(1)* | O(1) | O(1) | O(1) |
| åˆ é™¤ | O(n) | O(1) | O(1) | O(1) |
| éå† | O(n) | O(n) | O(n) | O(n) |

*æ•°ç»„æœ«å°¾æ’å…¥ä¸º O(1),å…¶ä»–ä½ç½®ä¸º O(n)

### 8.2 æ€§èƒ½æµ‹è¯•

```javascript
// æ€§èƒ½å¯¹æ¯”æµ‹è¯•
function benchmark(name, fn, iterations = 1000000) {
  const start = performance.now();
  for (let i = 0; i < iterations; i++) {
    fn(i);
  }
  const end = performance.now();
  console.log(`${name}: ${(end - start).toFixed(2)}ms`);
}

// æŸ¥æ‰¾æ€§èƒ½
const arr = Array.from({ length: 10000 }, (_, i) => i);
const set = new Set(arr);
const map = new Map(arr.map(v => [v, v]));
const obj = Object.fromEntries(arr.map(v => [v, v]));

console.log('=== æŸ¥æ‰¾æ€§èƒ½ ===');
benchmark('Array.includes', i => arr.includes(5000));
benchmark('Set.has', i => set.has(5000));
benchmark('Map.has', i => map.has(5000));
benchmark('Object.hasOwnProperty', i => obj.hasOwnProperty(5000));

// æ’å…¥æ€§èƒ½
console.log('\n=== æ’å…¥æ€§èƒ½ ===');
benchmark('Array.push', i => {
  const a = [];
  a.push(i);
});
benchmark('Set.add', i => {
  const s = new Set();
  s.add(i);
});
benchmark('Map.set', i => {
  const m = new Map();
  m.set(i, i);
});
benchmark('Object assign', i => {
  const o = {};
  o[i] = i;
});

// åˆ é™¤æ€§èƒ½
console.log('\n=== åˆ é™¤æ€§èƒ½ ===');
benchmark('Array.splice', i => {
  const a = [1, 2, 3, 4, 5];
  a.splice(2, 1);
});
benchmark('Set.delete', i => {
  const s = new Set([1, 2, 3, 4, 5]);
  s.delete(3);
});
benchmark('Map.delete', i => {
  const m = new Map([[1, 1], [2, 2], [3, 3]]);
  m.delete(2);
});
benchmark('delete operator', i => {
  const o = { a: 1, b: 2, c: 3 };
  delete o.b;
});
```

### 8.3 å†…å­˜ä½¿ç”¨å¯¹æ¯”

```javascript
// å†…å­˜å ç”¨æµ‹è¯•(éœ€è¦ Node.js ç¯å¢ƒ)
function measureMemory(name, fn) {
  if (global.gc) global.gc(); // æ‰‹åŠ¨è§¦å‘ GC
  const before = process.memoryUsage().heapUsed;
  
  fn();
  
  if (global.gc) global.gc();
  const after = process.memoryUsage().heapUsed;
  
  const used = ((after - before) / 1024 / 1024).toFixed(2);
  console.log(`${name}: ${used} MB`);
}

// æµ‹è¯•
const size = 100000;

measureMemory('Array', () => {
  const arr = Array.from({ length: size }, (_, i) => i);
});

measureMemory('Set', () => {
  const set = new Set(Array.from({ length: size }, (_, i) => i));
});

measureMemory('Map', () => {
  const map = new Map(Array.from({ length: size }, (_, i) => [i, i]));
});

measureMemory('Object', () => {
  const obj = {};
  for (let i = 0; i < size; i++) {
    obj[i] = i;
  }
});
```

### 8.4 æœ€ä½³å®è·µ

#### 1. é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„

```javascript
// âŒ é”™è¯¯: ä½¿ç”¨æ•°ç»„åšæŸ¥æ‰¾
const userIds = [1, 2, 3, 4, 5, /*...1000 items*/];
if (userIds.includes(targetId)) { // O(n)
  // ...
}

// âœ… æ­£ç¡®: ä½¿ç”¨ Set
const userIds = new Set([1, 2, 3, 4, 5, /*...1000 items*/]);
if (userIds.has(targetId)) { // O(1)
  // ...
}
```

#### 2. é¿å…è¿‡åº¦ä½¿ç”¨ WeakMap/WeakSet

```javascript
// âŒ é”™è¯¯: éœ€è¦éå†æ—¶ä½¿ç”¨ WeakMap
const userPreferences = new WeakMap();
// æ— æ³•éå†æ‰€æœ‰ç”¨æˆ·åå¥½!

// âœ… æ­£ç¡®: ä½¿ç”¨ Map
const userPreferences = new Map();
for (let [user, prefs] of userPreferences) {
  console.log(user, prefs);
}
```

#### 3. åˆç†ä½¿ç”¨é”®ç±»å‹

```javascript
// âŒ é”™è¯¯: ä½¿ç”¨å¯¹è±¡å­—é¢é‡ä½œä¸º Map çš„é”®
const cache = new Map();
cache.set({ id: 1 }, 'value'); // æ¯æ¬¡éƒ½æ˜¯æ–°å¯¹è±¡!
console.log(cache.get({ id: 1 })); // undefined

// âœ… æ­£ç¡®: å¤ç”¨é”®å¯¹è±¡
const cache = new Map();
const key = { id: 1 };
cache.set(key, 'value');
console.log(cache.get(key)); // 'value'
```

#### 4. å¤§æ•°æ®é›†å»é‡ä¼˜åŒ–

```javascript
// âŒ æ…¢: ä½¿ç”¨ filter
function removeDuplicates(arr) {
  return arr.filter((item, index) => arr.indexOf(item) === index);
  // O(nÂ²)
}

// âœ… å¿«: ä½¿ç”¨ Set
function removeDuplicates(arr) {
  return [...new Set(arr)]; // O(n)
}

// ğŸš€ æ›´å¿«: å¯¹äºå¤§å‹æ•°ç»„,ç›´æ¥è¿”å› Set
function removeDuplicates(arr) {
  return new Set(arr); // ä¸è½¬ä¸ºæ•°ç»„,ä¿æŒ Set
}
```

#### 5. WeakMap ç”¨äºç¼“å­˜æ—¶çš„æ³¨æ„äº‹é¡¹

```javascript
// âœ… æ­£ç¡®: å¯¹è±¡ä¸å†ä½¿ç”¨æ—¶è‡ªåŠ¨æ¸…ç†
const cache = new WeakMap();

function processData(obj) {
  if (cache.has(obj)) {
    return cache.get(obj);
  }
  
  const result = expensiveOperation(obj);
  cache.set(obj, result);
  return result;
}

// âš ï¸ æ³¨æ„: åŸºæœ¬ç±»å‹ä¸èƒ½ä½œä¸ºé”®
// cache.set('key', 'value'); // TypeError
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

1. **Set**: å”¯ä¸€å€¼é›†åˆ,é€‚åˆå»é‡ã€é›†åˆè¿ç®—
2. **Map**: ä»»æ„ç±»å‹é”®å€¼å¯¹,é€‚åˆé”®ä¸æ˜¯å­—ç¬¦ä¸²çš„åœºæ™¯
3. **WeakSet**: å¼±å¼•ç”¨å¯¹è±¡é›†åˆ,é€‚åˆå¯¹è±¡æ ‡è®°
4. **WeakMap**: å¼±å¼•ç”¨é”®å€¼å¯¹,é€‚åˆç§æœ‰æ•°æ®ã€DOM å…ƒæ•°æ®

### é€‰æ‹©æŒ‡å—

| åœºæ™¯ | æ¨è |
|------|------|
| æ•°ç»„å»é‡ | Set |
| é”®ä¸æ˜¯å­—ç¬¦ä¸² | Map |
| é¢‘ç¹å¢åˆ æŸ¥ | Set/Map |
| éœ€è¦éå† | Set/Map |
| å¯¹è±¡ç§æœ‰æ•°æ® | WeakMap |
| DOM å…ƒæ•°æ® | WeakMap |
| å¯¹è±¡æ ‡è®° | WeakSet |
| é˜²æ­¢å†…å­˜æ³„æ¼ | WeakMap/WeakSet |

### é¢è¯•å‡†å¤‡æ¸…å•

- [ ] ç†è§£å››ç§æ•°æ®ç»“æ„çš„æ ¸å¿ƒå·®å¼‚
- [ ] æŒæ¡å“ˆå¸Œè¡¨çš„åŸºæœ¬åŸç†
- [ ] èƒ½å®ç°å¸¸è§ç®—æ³•(å»é‡ã€LRUã€æ·±å…‹éš†)
- [ ] äº†è§£å¼±å¼•ç”¨å’Œåƒåœ¾å›æ”¶æœºåˆ¶
- [ ] ç†Ÿæ‚‰å®é™…åº”ç”¨åœºæ™¯
- [ ] èƒ½æ¯”è¾ƒæ—¶é—´/ç©ºé—´å¤æ‚åº¦

### è¿›é˜¶å­¦ä¹ æ–¹å‘

1. **V8 å¼•æ“å®ç°ç»†èŠ‚**: ç ”ç©¶ V8 æºç ä¸­çš„å“ˆå¸Œè¡¨å®ç°
2. **å…¶ä»–è¯­è¨€å¯¹æ¯”**: Java HashSet/HashMap, Python set/dict
3. **æ•°æ®ç»“æ„è®¾è®¡**: å®ç°æ›´å¤æ‚çš„æ•°æ®ç»“æ„(è·³è¡¨ã€å¸ƒéš†è¿‡æ»¤å™¨)
4. **æ€§èƒ½ä¼˜åŒ–**: å­¦ä¹ æ›´å¤šæ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–æŠ€å·§

---

**å‚è€ƒèµ„æ–™**:
- [MDN - Set](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Set)
- [MDN - Map](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Map)
- [ECMAScript Specification](https://tc39.es/ecma262/)
- [V8 Blog](https://v8.dev/blog)