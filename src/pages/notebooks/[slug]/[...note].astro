---
import type { CollectionEntry } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import NotebookLayout from '../../../components/NotebookLayout.astro';
import { getCollection } from 'astro:content';
import { getNotebookBySlug, getNotesByNotebook } from '../../../utils/notebooks';

export async function getStaticPaths() {
  const notes = await getCollection('notes');
  return notes.map((note) => {
    const notebookSlug = note.data.notebook;
    // 移除 slug 中的笔记本文件夹前缀，因为它已经在路由的 [slug] 部分
    // 例如：note.slug 是 "browser/rander"，只需要 "rander" 部分
    const noteSlugWithoutFolder = note.slug.replace(`${notebookSlug}/`, '');
    return {
      params: { slug: notebookSlug, note: noteSlugWithoutFolder },
      props: { note, notebookSlug },
    };
  });
}

const { note, notebookSlug } = Astro.props as {
  note: CollectionEntry<'notes'>;
  notebookSlug: string;
};
const notebook = await getNotebookBySlug(notebookSlug);
if (!notebook) throw new Error(`Notebook not found: ${notebookSlug}`);
const notes = await getNotesByNotebook(notebookSlug);
const { title: nbTitle, description } = notebook.data;
const pageTitle = `${note.data.title} - ${nbTitle}`;
---

<Layout title={pageTitle} description={description || undefined}>
  <NotebookLayout
    notebook={notebook}
    notebookSlug={notebookSlug}
    notes={notes}
    noteSlug={note.slug}
    noteEntry={note}
  />
</Layout>
